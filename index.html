<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Эксперимент</title>

  <!-- jsPsych (ядро) -->
  <script src="https://unpkg.com/jspsych@7.3.3/dist/jspsych.js"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/dist/jspsych.css" rel="stylesheet" />

  <!-- Плагины -->
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.1.2"></script>

  <style>
    body { background-color: #f5f5f5; }
    .jspsych-content { max-width: 800px; }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

  <!-- ВЕСЬ JS-КОД СЮДА -->
  <script>
    // Инициализация jsPsych
    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      on_finish: function() {
        // Сохранить данные в CSV и скачать
        const csv = jsPsych.data.get().csv();
        const first = jsPsych.data.get().values()[0] || {};
        const participant = first.participant || 'NOID';
        const group = first.group || 'NOGROUP';
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `data_${participant}_g${group}_${timestamp}.csv`;

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }
    });

    // Массив с таймлайном
    let timeline = [];

    // 1. Ввод ID участника
    const participant_id_trial = {
      type: jsPsychSurveyText,
      questions: [
        { prompt: 'Введите ID участника:', name: 'participant_id', required: true }
      ],
      button_label: 'Продолжить',
      on_finish: function(data){
        const id = data.response.participant_id.trim();
        jsPsych.data.addProperties({ participant: id });
      }
    };
    timeline.push(participant_id_trial);

    // 2. Рандомизация по группе (1, 2, 3)
    const assign_group_trial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: '<p>Назначение группы...</p><p>Нажмите кнопку, чтобы продолжить.</p>',
      choices: ['Продолжить'],
      on_start: function(trial){
        const group = Math.floor(Math.random() * 3) + 1;
        jsPsych.data.addProperties({ group: group });
        trial.stimulus = `<p>Вам назначена группа: ${group} (это пока для проверки).</p><p>Нажмите кнопку, чтобы продолжить.</p>`;
      }
    };
    timeline.push(assign_group_trial);

    // 3. Простой демонстрационный trial
    const demo_trial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<p>Тестовый экран. Нажмите пробел.</p>',
      choices: [' ']
    };
    timeline.push(demo_trial);

    // Старт эксперимента
    jsPsych.run(timeline);
  </script>
</body>
</html>
